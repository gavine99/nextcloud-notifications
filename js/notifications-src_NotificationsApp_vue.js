"use strict";(()=>{(self.webpackChunknotifications=self.webpackChunknotifications||[]).push([["src_NotificationsApp_vue"],{8769:(g,_,n)=>{n.d(_,{Z:()=>d});var f=n(7537),p=n.n(f),h=n(3645),m=n.n(h),o=m()(p());o.push([g.id,".notification[data-v-707f93b6]{background-color:var(--color-main-background)}.notification[data-v-707f93b6] img.notification-icon{display:flex;width:32px;height:32px;filter:var(--background-invert-if-dark)}.notification[data-v-707f93b6] .rich-text--wrapper{white-space:pre-wrap;word-break:break-word}.notification .notification-subject[data-v-707f93b6]{padding:4px}.notification a.notification-subject[data-v-707f93b6]:focus-visible{box-shadow:inset 0 0 0 2px var(--color-main-text) !important}","",{version:3,sources:["webpack://./src/Components/Notification.vue"],names:[],mappings:"AACA,+BACC,6CAAA,CAEA,qDACC,YAAA,CACA,UAAA,CACA,WAAA,CACA,uCAAA,CAED,mDACC,oBAAA,CACA,qBAAA,CAGD,qDACC,WAAA,CAGD,oEACC,4DAAA",sourcesContent:[`
.notification {
	background-color: var(--color-main-background);

	:deep(img.notification-icon) {
		display: flex;
		width: 32px;
		height: 32px;
		filter: var(--background-invert-if-dark);
	}
	:deep(.rich-text--wrapper) {
		white-space: pre-wrap;
		word-break: break-word;
	}

	.notification-subject {
		padding: 4px;
	}

	a.notification-subject:focus-visible {
		box-shadow: inset 0 0 0 2px var(--color-main-text) !important; // override rule in core/css/headers.scss #header a:focus-visible
	}
}

`],sourceRoot:""}]);const d=o},1343:(g,_,n)=>{n.d(_,{Z:()=>d});var f=n(7537),p=n.n(f),h=n(3645),m=n.n(h),o=m()(p());o.push([g.id,'.external[data-v-042e7c76]:after{content:" \u2197"}',"",{version:3,sources:["webpack://./DefaultParameter.vue","webpack://./src/Components/Parameters/DefaultParameter.vue"],names:[],mappings:"AAAA,iCCCA,YACC",sourcesContent:['.external:after{content:" \u2197"}',`
.external:after {
	content: ' \u2197';
}
`],sourceRoot:""}]);const d=o},5959:(g,_,n)=>{n.d(_,{Z:()=>d});var f=n(7537),p=n.n(f),h=n(3645),m=n.n(h),o=m()(p());o.push([g.id,".mention[data-v-62148f13]{display:contents;white-space:nowrap}","",{version:3,sources:["webpack://./src/Components/Parameters/User.vue"],names:[],mappings:"AACA,0BACC,gBAAA,CACA,kBAAA",sourcesContent:[`
.mention {
	display: contents;
	white-space: nowrap;
}
`],sourceRoot:""}]);const d=o},8113:(g,_,n)=>{n.d(_,{Z:()=>d});var f=n(7537),p=n.n(f),h=n(3645),m=n.n(h),o=m()(p());o.push([g.id,".notification-container[data-v-92619230]{overflow:hidden}.notification-wrapper[data-v-92619230]{max-height:calc(100vh - 200px);overflow:auto}[data-v-92619230] .empty-content{margin:12vh 10px}[data-v-92619230] .empty-content p{color:var(--color-text-maxcontrast)}.icon-alert-outline[data-v-92619230]{background-size:64px;width:64px;height:64px}.fade-enter-active[data-v-92619230],.fade-leave-active[data-v-92619230]{transition:opacity var(--animation-quick) ease}.fade-enter-from[data-v-92619230],.fade-leave-to[data-v-92619230]{opacity:0}.list-move[data-v-92619230],.list-enter-active[data-v-92619230],.list-leave-active[data-v-92619230]{transition:all var(--animation-quick) ease}.list-enter-from[data-v-92619230],.list-leave-to[data-v-92619230]{opacity:0;transform:translateX(30px)}.list-leave-active[data-v-92619230]{width:100%}","",{version:3,sources:["webpack://./src/NotificationsApp.vue"],names:[],mappings:"AACA,yCAEC,eAAA,CAGD,uCACC,8BAAA,CACA,aAAA,CAGD,iCACC,gBAAA,CAEA,mCACC,mCAAA,CAIF,qCACC,oBAAA,CACA,UAAA,CACA,WAAA,CAGD,wEAEC,8CAAA,CAGD,kEAEC,SAAA,CAGD,oGAGC,0CAAA,CAGD,kEAEC,SAAA,CACA,0BAAA,CAGD,oCACC,UAAA",sourcesContent:[`
.notification-container {
	/* Prevent slide animation to go out of the div */
	overflow: hidden;
}

.notification-wrapper {
	max-height: calc(100vh - 50px * 4);
	overflow: auto;
}

::v-deep .empty-content {
	margin: 12vh 10px;

	p {
		color: var(--color-text-maxcontrast);
	}
}

.icon-alert-outline {
	background-size: 64px;
	width: 64px;
	height: 64px;
}

.fade-enter-active,
.fade-leave-active {
	transition: opacity var(--animation-quick) ease;
}

.fade-enter-from,
.fade-leave-to {
	opacity: 0;
}

.list-move,
.list-enter-active,
.list-leave-active {
	transition: all var(--animation-quick) ease;
}

.list-enter-from,
.list-leave-to {
	opacity: 0;
	transform: translateX(30px);
}

.list-leave-active {
	width: 100%;
}
`],sourceRoot:""}]);const d=o},5578:(g,_,n)=>{n.r(_),n.d(_,{default:()=>Bt});var f=function(){var e=this,s=e._self._c;return e.shutdown?e._e():s("NcHeaderMenu",{staticClass:"notifications-button",attrs:{id:"notifications","exclude-click-outside-selectors":[".popover"],open:e.open,"aria-label":e.t("notifications","Notifications")},on:{"update:open":function(a){e.open=a},open:e.onOpen},scopedSlots:e._u([{key:"trigger",fn:function(){return[e.notifications.length===0&&e.webNotificationsGranted!==null&&!e.hasThrottledPushNotifications?s("Bell",{staticClass:"notifications-button__icon",attrs:{size:20,title:e.t("notifications","Notifications")}}):s("svg",{staticClass:"notifications-button__icon",attrs:{xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",version:"1.1",width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor"}},[s("path",{attrs:{d:"M 19,11.79 C 18.5,11.92 18,12 17.5,12 14.47,12 12,9.53 12,6.5 12,5.03 12.58,3.7 13.5,2.71 13.15,2.28 12.61,2 12,2 10.9,2 10,2.9 10,4 V 4.29 C 7.03,5.17 5,7.9 5,11 v 6 l -2,2 v 1 H 21 V 19 L 19,17 V 11.79 M 12,23 c 1.11,0 2,-0.89 2,-2 h -4 c 0,1.11 0.9,2 2,2 z"}}),e._v(" "),s("path",{staticClass:"notification__dot",class:e.isRedThemed?"notification__dot--white":"",attrs:{d:"M 21,6.5 C 21,8.43 19.43,10 17.5,10 15.57,10 14,8.43 14,6.5 14,4.57 15.57,3 17.5,3 19.43,3 21,4.57 21,6.5"}}),e._v(" "),e.hasThrottledPushNotifications?s("path",{staticClass:"notification__dot notification__dot--warning",class:e.isOrangeThemed?"notification__dot--white":"",attrs:{d:"M 21,6.5 C 21,8.43 19.43,10 17.5,10 15.57,10 14,8.43 14,6.5 14,4.57 15.57,3 17.5,3 19.43,3 21,4.57 21,6.5"}}):e._e()])]},proxy:!0}],null,!1,760905135)},[e._v(" "),s("div",{ref:"container",staticClass:"notification-container"},[s("transition",{attrs:{name:"fade",mode:"out-in"}},[e.notifications.length>0?s("div",[s("transition-group",{staticClass:"notification-wrapper",attrs:{name:"list",tag:"ul"}},[e.hasThrottledPushNotifications?s("Notification",{key:-2016,attrs:{datetime:"warning",app:"core",icon:e.warningIcon,"external-link":"https://nextcloud.com/fairusepolicy",message:e.emptyContentDescription,subject:e.emptyContentMessage,index:2016}}):e._e(),e._v(" "),e._l(e.notifications,function(a,l){return s("Notification",e._b({key:a.notificationId,attrs:{index:l},on:{remove:e.onRemove}},"Notification",a,!1))})],2),e._v(" "),e.notifications.length>0?s("span",{staticClass:"dismiss-all",on:{click:e.onDismissAll}},[s("NcButton",{attrs:{type:"tertiary"},on:{click:e.onDismissAll},scopedSlots:e._u([{key:"icon",fn:function(){return[s("Close",{attrs:{size:20}})]},proxy:!0}],null,!1,2121748766)},[e._v(`
						`+e._s(e.t("notifications","Dismiss all notifications"))+`
					`)])],1):e._e()],1):s("NcEmptyContent",{attrs:{name:e.emptyContentMessage,description:e.emptyContentDescription},scopedSlots:e._u([{key:"icon",fn:function(){return[e.hasThrottledPushNotifications?s("span",{staticClass:"icon icon-alert-outline"}):s("Bell")]},proxy:!0},e.hasThrottledPushNotifications?{key:"action",fn:function(){return[s("NcButton",{attrs:{type:"primary",href:"https://nextcloud.com/fairusepolicy",target:"_blank",rel:"noreferrer noopener"},scopedSlots:e._u([{key:"icon",fn:function(){return[s("Message",{attrs:{size:20}})]},proxy:!0}],null,!1,1386745923)},[e._v(`
						`+e._s(e.t("notifications","Contact Nextcloud GmbH"))+` \u2197
					`)])]},proxy:!0}:null],null,!0)})],1)],1)])},p=[],h=function(){var e=this,s=e._self._c;return s("li",{staticClass:"notification",attrs:{"data-id":e.notificationId,"data-timestamp":e.timestamp,"data-object-type":e.objectType,"data-app":e.app}},[s("div",{staticClass:"notification-heading"},[s("span",{staticClass:"hidden-visually"},[e._v(e._s(e.absoluteDate))]),e._v(" "),e.timestamp?s("span",{staticClass:"notification-time live-relative-timestamp",attrs:{title:e.absoluteDate,"data-timestamp":e.timestamp}},[e._v(e._s(e.relativeDate))]):e._e(),e._v(" "),e.timestamp?s("NcButton",{staticClass:"notification-dismiss-button",attrs:{type:"tertiary","aria-label":e.t("notifications","Dismiss")},on:{click:e.onDismissNotification},scopedSlots:e._u([{key:"icon",fn:function(){return[s("Close",{attrs:{size:20}})]},proxy:!0}],null,!1,2121748766)}):e._e()],1),e._v(" "),e.externalLink?s("a",{staticClass:"notification-subject full-subject-link external",attrs:{href:e.externalLink,target:"_blank",rel:"noreferrer noopener"}},[s("span",{staticClass:"image"},[s("img",{staticClass:"notification-icon",attrs:{src:e.icon,alt:""}})]),e._v(" "),s("span",{staticClass:"subject"},[e._v(e._s(e.subject)+" \u2197")])]):e.useLink?s("a",{staticClass:"notification-subject full-subject-link",attrs:{href:e.link}},[e.icon?s("span",{staticClass:"image"},[s("img",{staticClass:"notification-icon",attrs:{src:e.icon,alt:""}})]):e._e(),e._v(" "),e.subjectRich?s("NcRichText",{attrs:{text:e.subjectRich,arguments:e.preparedSubjectParameters}}):s("span",{staticClass:"subject"},[e._v(e._s(e.subject))])],1):s("div",{staticClass:"notification-subject"},[e.icon?s("span",{staticClass:"image"},[s("img",{staticClass:"notification-icon",attrs:{src:e.icon,alt:""}})]):e._e(),e._v(" "),e.subjectRich?s("NcRichText",{attrs:{text:e.subjectRich,arguments:e.preparedSubjectParameters}}):s("span",{staticClass:"subject"},[e._v(e._s(e.subject))])],1),e._v(" "),e.message?s("div",{staticClass:"notification-message",on:{click:e.onClickMessage}},[s("div",{staticClass:"message-container",class:{collapsed:e.isCollapsedMessage}},[e.messageRich?s("NcRichText",{attrs:{text:e.messageRich,arguments:e.preparedMessageParameters,autolink:!0}}):s("span",[e._v(e._s(e.message))])],1),e._v(" "),e.isCollapsedMessage?s("div",{staticClass:"notification-overflow"}):e._e()]):e._e(),e._v(" "),e.actions.length?s("div",{staticClass:"notification-actions"},e._l(e.actions,function(a,l){return s("Action",e._b({key:l,attrs:{"notification-index":e.index}},"Action",a,!1))}),1):e.externalLink?s("div",{staticClass:"notification-actions"},[s("NcButton",{staticClass:"action-button pull-right",attrs:{type:"primary",href:"https://nextcloud.com/fairusepolicy",target:"_blank",rel:"noreferrer noopener"},scopedSlots:e._u([{key:"icon",fn:function(){return[s("Message",{attrs:{size:20}})]},proxy:!0}])},[e._v(`
			`+e._s(e.t("notifications","Contact Nextcloud GmbH"))+` \u2197
		`)])],1):e._e()])},m=[],o=n(7040),d=n(8013),G=n(8652),Z=n(6034),L=n(2228),w=n(4024),K=function(){var e=this,s=e._self._c;return e.isWebLink?s("NcButton",{staticClass:"action-button pull-right",attrs:{type:"primary",href:e.link},on:{click:e.onClickActionButtonWeb}},[e._v(`
	`+e._s(e.label)+`
`)]):e.isWebLink?e._e():s("NcButton",{staticClass:"action-button pull-right",attrs:{type:e.buttonType},on:{click:e.onClickActionButton}},[e._v(`
	`+e._s(e.label)+`
`)])},H=[],u=n(9183);const X={name:"Action",components:{NcButton:d.Z},props:{label:{type:String,default:"",required:!0},link:{type:String,default:"",required:!0},type:{type:String,default:"",required:!0},primary:{type:Boolean,default:!1,required:!0},notificationIndex:{type:Number,required:!0}},data(){return{tabbed:!1}},computed:{isWebLink(){return this.typeWithDefault==="WEB"},typeWithDefault(){return this.type||"GET"},buttonType(){return this.primary?"primary":"secondary"}},methods:{async onClickActionButtonWeb(i){try{const e={cancelAction:!1,notification:this.$parent.$props,action:{url:this.link,type:this.typeWithDefault}};await(0,u.j8)("notifications:action:execute",e),e.cancelAction&&i.preventDefault()}catch(e){console.error("Failed to perform action",e),(0,w.x2)(t("notifications","Failed to perform action"))}},async onClickActionButton(){try{const i={cancelAction:!1,notification:this.$parent.$props,action:{url:this.link,type:this.typeWithDefault}};if(await(0,u.j8)("notifications:action:execute",i),i.cancelAction)return;await(0,o.ZP)({method:this.typeWithDefault,url:this.link}),this.$parent._$el.fadeOut(OC.menuSpeed),this.$parent.$emit("remove",this.notificationIndex),(0,u.j8)("notifications:action:executed",i);try{$("body").trigger(new $.Event("OCA.Notification.Action",{notification:this.$parent,action:{url:this.link,type:this.typeWithDefault}}))}catch(e){console.error(e)}}catch(i){console.error("Failed to perform action",i),(0,w.x2)(t("notifications","Failed to perform action"))}}}};var A=n(1900),z=(0,A.Z)(X,K,H,!1,null,null,null);const J=z.exports;var C=n(1480),x=n(5846),V=function(){var e=this,s=e._self._c;return e.hasInternalLink?s("a",{attrs:{href:e.link}},[s("strong",[e._v(e._s(e.name))])]):e.link?s("a",{staticClass:"external",attrs:{href:e.link,target:"_blank",rel:"noopener noreferrer"}},[s("strong",[e._v(e._s(e.name))])]):s("strong",[e._v(e._s(e.name))])},Y=[];const Q={name:"DefaultParameter",props:{type:{type:String,required:!0},id:{type:[Number,String],required:!0},name:{type:String,required:!0},link:{type:String,default:""}},computed:{hasInternalLink(){return this.link&&(this.type==="deck-board"||this.type==="deck-card")}}};var q=n(3379),D=n.n(q),tt=n(7795),E=n.n(tt),et=n(569),k=n.n(et),it=n(3565),T=n.n(it),st=n(9216),j=n.n(st),nt=n(4589),S=n.n(nt),O=n(1343),b={};b.styleTagTransform=S(),b.setAttributes=T(),b.insert=k().bind(null,"head"),b.domAPI=E(),b.insertStyleElement=j();var Ft=D()(O.Z,b);const Wt=O.Z&&O.Z.locals?O.Z.locals:void 0;var at=(0,A.Z)(Q,V,Y,!1,null,"042e7c76",null);const ot=at.exports;var rt=function(){var e=this,s=e._self._c;return s("a",{staticClass:"filename",attrs:{title:e.title,href:e.link}},[e._v(e._s(e.name))])},lt=[];const ct={name:"File",props:{type:{type:String,required:!0},id:{type:[Number,String],required:!0},name:{type:String,required:!0},path:{type:String,default:""},link:{type:String,default:""}},computed:{title(){const i=this.path.lastIndexOf("/"),e=this.path.indexOf("/"),s=this.path.substring(e===0?1:0,i);return s.length===0?"":t("notifications","in {path}",{path:s})}}};var dt=(0,A.Z)(ct,rt,lt,!1,null,null,null);const ut=dt.exports;var _t=function(){var e=this,s=e._self._c;return s("div",{staticClass:"mention"},[e.cloudId?s("strong",{attrs:{title:e.cloudId}},[e._v(`
		`+e._s(e.name)+`
	`)]):s("NcUserBubble",{attrs:{"display-name":e.name,user:e.id}})],1)},ft=[],pt=n(4624);const ht={name:"User",components:{NcUserBubble:pt.Z},props:{type:{type:String,required:!0},id:{type:String,required:!0},name:{type:String,required:!0},server:{type:String,default:""}},computed:{cloudId(){return this.server?this.id+"@"+this.server:""}}};var B=n(5959),N={};N.styleTagTransform=S(),N.setAttributes=T(),N.insert=k().bind(null,"head"),N.domAPI=E(),N.insertStyleElement=j();var Lt=D()(B.Z,N);const Gt=B.Z&&B.Z.locals?B.Z.locals:void 0;var mt=(0,A.Z)(ht,_t,ft,!1,null,"62148f13",null);const vt=mt.exports,gt={name:"Notification",components:{Action:J,NcButton:d.Z,Close:Z.Z,Message:L.Z,NcRichText:G.ZP},props:{notificationId:{type:Number,default:-1},datetime:{type:String,default:""},app:{type:String,default:""},icon:{type:String,default:""},link:{type:String,default:""},externalLink:{type:String,default:""},user:{type:String,default:""},message:{type:String,default:""},messageRich:{type:String,default:""},messageRichParameters:{type:[Object,Array],default(){return{}}},subject:{type:String,default:""},subjectRich:{type:String,default:""},subjectRichParameters:{type:[Object,Array],default(){return{}}},objectType:{type:String,default:""},objectId:{type:String,default:""},shouldNotify:{type:Boolean,default:!0},actions:{type:Array,default(){return[]}},index:{type:Number,default:-1}},data(){return{showFullMessage:!1}},_$el:null,computed:{timestamp(){return this.datetime==="warning"?0:new Date(this.datetime).valueOf()},absoluteDate(){return this.datetime==="warning"?"":(0,x.Z)(this.timestamp).format("LLL")},relativeDate(){if(this.datetime==="warning")return"";const i=(0,x.Z)().diff((0,x.Z)(this.timestamp));return i>=0&&i<45e3?t("core","seconds ago"):(0,x.Z)(this.timestamp).fromNow()},useLink(){if(!this.link)return!1;let i=!1;return Object.keys(this.subjectRichParameters).forEach(e=>{this.subjectRichParameters[e].link&&(i=!0)}),!i},preparedSubjectParameters(){return this.prepareParameters(this.subjectRichParameters)},preparedMessageParameters(){return this.prepareParameters(this.messageRichParameters)},isCollapsedMessage(){return this.message.length>200&&!this.showFullMessage}},mounted(){this._$el=$(this.$el)},methods:{prepareParameters(i){const e={};return Object.keys(i).forEach(s=>{const a=i[s].type;a==="user"?e[s]={component:vt,props:i[s]}:a==="file"?e[s]={component:ut,props:i[s]}:e[s]={component:ot,props:i[s]}}),e},onClickMessage(i){i.target.closest(".rich-text--wrapper")?this.showFullMessage=!this.showFullMessage:!this.messageRich&&this.message&&(this.showFullMessage=!this.showFullMessage)},onDismissNotification(){o.ZP.delete((0,C.Ii)("apps/notifications/api/v2/notifications/{id}",{id:this.notificationId})).then(()=>{this.$emit("remove",this.index)}).catch(()=>{(0,w.x2)(t("notifications","Failed to dismiss notification"))})}}};var M=n(8769),P={};P.styleTagTransform=S(),P.setAttributes=T(),P.insert=k().bind(null,"head"),P.domAPI=E(),P.insertStyleElement=j();var Kt=D()(M.Z,P);const Ht=M.Z&&M.Z.locals?M.Z.locals:void 0;var yt=(0,A.Z)(gt,h,m,!1,null,"707f93b6",null);const At=yt.exports;var Ct=n(3907),F=n(7963),bt=n(2556);const r=(0,bt.Kc)("notifications").clearOnLogout().persist().build(),Nt=async(i,e,s,a)=>{const l=parseInt(r.getItem("lastUpdated"),10),c=r.getItem("tabId"),v=(0,x.Z)().format("X");return(s||c===i&&l+25<v||c===i&&a||l+35<v)&&(r.setItem("tabId",i),r.setItem("lastUpdated",v),await It(e)),{status:parseInt(r.getItem("status"),10),headers:JSON.parse(r.getItem("headers")||"[]"),data:JSON.parse(r.getItem("data")||"[]"),tabId:r.getItem("tabId"),lastUpdated:parseInt(r.getItem("lastUpdated"),10)}},Pt=i=>(i.notificationId=i.notification_id,i.objectId=i.object_id,i.objectType=i.object_type,delete i.notification_id,delete i.object_id,delete i.object_type,i),It=async i=>{let e={};i&&(e={headers:{"If-None-Match":i}});try{const s=await o.ZP.get((0,C.Ii)("apps/notifications/api/v2/notifications"),e);r.setItem("status",""+s.status),s.status!==204&&(r.setItem("headers",JSON.stringify(s.headers)),r.setItem("data",JSON.stringify(s.data.ocs.data.map(Pt))))}catch(s){s?.response?.status?r.setItem("status",""+s.response.status):r.setItem("status","500")}};var xt=n(2534),wt=n(7421),Dt=n(6748),Et=n(5878),kt=n(7584),W=n(1766);const Tt=i=>{if(!i.shouldNotify)return;const e=new Notification(i.subject,{title:i.subject,lang:OC.getLocale(),body:i.message,icon:i.icon,tag:i.notificationId});i.link&&(e.onclick=async function(s){const a={cancelAction:!1,notification:i,action:{url:i.link,type:"WEB"}};await(0,u.j8)("notifications:action:execute",a),a.cancelAction||(console.debug("Redirecting because of a click onto a notification",i.link),window.location.href=i.link),window.focus()}),jt(i)},jt=i=>{if(i.app==="spreed"&&i.objectType==="call"){if((0,F.j)("notifications","sound_talk")){const e={src:[(0,C.FW)("notifications","img","talk.ogg")],html5:!0,volume:.5},s=new W.Howl(e),a=s._sounds[0]._node.sinkId??"";s.play();const l=r.getItem("secondary_speaker")==="true",c=JSON.parse(r.getItem("secondary_speaker_device"))?.id??null;if(l&&c&&a!==c){const v=new W.Howl(e);s._sounds[0]._node.setSinkId?.(c).then(()=>console.debug("Audio output successfully redirected to secondary speaker")).catch(y=>console.error("Failed to redirect audio output:",y)),v.play()}}}else(0,F.j)("notifications","sound_notification")&&new W.Howl({src:[(0,C.FW)("notifications","img","notification.ogg")],volume:.5}).play()},St={name:"NotificationsApp",components:{NcButton:d.Z,Close:Z.Z,Bell:wt.Z,Message:L.Z,NcEmptyContent:Dt.Z,NcHeaderMenu:kt.Z,Notification:At},data(){return{webNotificationsGranted:!1,backgroundFetching:!1,hasNotifyPush:!1,shutdown:!1,theming:(0,Et.F)()?.theming||{},hasThrottledPushNotifications:(0,F.j)("notifications","throttled_push_notifications"),notifications:[],lastETag:null,lastTabId:null,userStatus:null,tabId:null,webNotificationsThresholdId:0,pollIntervalBase:3e4,pollIntervalCurrent:3e4,interval:null,pushEndpoints:null,open:!1}},_$icon:null,computed:{isRedThemed(){if(this.theming?.color){const i=this.rgbToHsl(this.theming.color.substring(1,3),this.theming.color.substring(3,5),this.theming.color.substring(5,7)),e=i[0]*360;return(e>=330||e<=15)&&i[1]>.4&&(i[2]>.1||i[2]<.6)}return!1},isOrangeThemed(){if(this.theming?.color){const i=this.rgbToHsl(this.theming.color.substring(1,3),this.theming.color.substring(3,5),this.theming.color.substring(5,7)),e=i[0]*360;return(e>=305||e<=64)&&i[1]>.7&&(i[2]>.1||i[2]<.6)}return!1},showBrowserNotifications(){return this.backgroundFetching&&this.webNotificationsGranted&&this.userStatus!=="dnd"&&this.tabId===this.lastTabId},emptyContentMessage(){return this.webNotificationsGranted===null?t("notifications","Requesting browser permissions to show notifications"):this.hasThrottledPushNotifications?t("notifications","Push notifications might be unreliable"):t("notifications","No notifications")},emptyContentDescription(){return this.hasThrottledPushNotifications?t("notifications","Nextcloud GmbH sponsors a free push notification gateway for private users. To ensure good service, the gateway limits the number of push notifications per server. For enterprise users, a more scalable gateway is available. Contact Nextcloud GmbH for more information."):""},warningIcon(){return(0,C.hp)("core","actions/alert-outline.svg")}},mounted(){this.tabId=OC.requestToken||""+Math.random(),this._$icon=$(this.$refs.icon),this._oldcount=0,console.debug("Registering notifications container as a menu"),OC.registerMenu($(this.$refs.button),$(this.$refs.container),void 0,!0),this.checkWebNotificationPermissions(),this._fetch(),(0,xt.listen)("notify_notification",()=>{this._fetchAfterNotifyPush()})&&(console.debug("Has notify_push enabled, slowing polling to 15 minutes"),this.pollIntervalBase=15*60*1e3,this.hasNotifyPush=!0),this._setPollingInterval(this.pollIntervalBase),this._watchTabVisibility(),(0,u.Ld)("networkOffline",this.handleNetworkOffline),(0,u.Ld)("networkOnline",this.handleNetworkOnline),(0,u.Ld)("user_status:status.updated",this.userStatusUpdated)},beforeDestroy(){(0,u.r1)("user_status:status.updated",this.userStatusUpdated),(0,u.r1)("networkOffline",this.handleNetworkOffline),(0,u.r1)("networkOnline",this.handleNetworkOnline)},methods:{userStatusUpdated(i){(0,Ct.ts)().uid===i.userId&&(this.userStatus=i.status)},onOpen(){this.requestWebNotificationPermissions()},handleNetworkOffline(){console.debug("Network is offline, slowing down pollingInterval to "+this.pollIntervalBase*10),this._setPollingInterval(this.pollIntervalBase*10)},handleNetworkOnline(){this._fetch(),console.debug("Network is online, reseting pollingInterval to "+this.pollIntervalBase),this._setPollingInterval(this.pollIntervalBase)},setupBackgroundFetcher(){OC.config.session_keepalive?(console.debug("Started background fetcher as session_keepalive is enabled"),this.interval=window.setInterval(this._backgroundFetch.bind(this),this.pollIntervalCurrent)):console.debug("Did not start background fetcher as session_keepalive is off")},onDismissAll(){o.ZP.delete((0,C.Ii)("apps/notifications/api/v2/notifications")).then(()=>{this.notifications=[]}).catch(()=>{(0,w.x2)(t("notifications","Failed to dismiss all notifications"))})},onRemove(i){this.notifications.splice(i,1)},rgbToHsl(i,e,s){i=parseInt(i,16)/255,e=parseInt(e,16)/255,s=parseInt(s,16)/255;const a=Math.max(i,e,s),l=Math.min(i,e,s);let c,v;const U=(a+l)/2;if(a===l)c=v=0;else{const y=a-l;switch(v=U>.5?y/(2-a-l):y/(a+l),a){case i:c=(e-s)/y+(e<s?6:0);break;case e:c=(s-i)/y+2;break;case s:c=(i-e)/y+4;break}c/=6}return[c,v,U]},_updateDocTitleOnNewNotifications(i){i.length>this._oldcount&&(this._oldcount=i.length,this.backgroundFetching&&document.hidden&&(document.title.startsWith("* ")||(document.title="* "+document.title)))},_restoreTitle(){document.title.startsWith("* ")&&(document.title=document.title.substring(2))},_fetchAfterNotifyPush(){this.backgroundFetching=!0,this.hasNotifyPush&&this.tabId!==this.lastTabId?(console.debug("Deferring notification refresh from browser storage are notify_push event to give the last tab the chance to do it"),setTimeout(()=>{this._fetch()},5e3)):(console.debug("Refreshing notifications are notify_push event"),this._fetch())},async _fetch(){this.notifications.length&&this.notifications[0].notificationId>this.webNotificationsThresholdId&&(this.webNotificationsThresholdId=this.notifications[0].notificationId);const i=await Nt(this.tabId,this.lastETag,!this.backgroundFetching,this.hasNotifyPush);i.status===204?(console.debug("Fetching notifications but no content, slowing down polling to "+this.pollIntervalBase*10),this._setPollingInterval(this.pollIntervalBase*10)):i.status===200?(this.userStatus=i.headers["x-nextcloud-user-status"],this.lastETag=i.headers.etag,this.lastTabId=i.tabId,this.notifications=i.data,this.processWebNotifications(i.data),console.debug("Got notification data, restoring default polling interval."),this._setPollingInterval(this.pollIntervalBase),this._updateDocTitleOnNewNotifications(this.notifications),!this.backgroundFetching&&this.notifications.length&&(this.webNotificationsThresholdId=this.notifications[0].notificationId)):i.status===304?this._setPollingInterval(this.pollIntervalBase):i.status===503?(console.info("Slowing down notifications: instance is in maintenance mode."),this._setPollingInterval(this.pollIntervalBase*10)):i.status===404?(console.info("Slowing down notifications: app is disabled."),this._setPollingInterval(this.pollIntervalBase*10)):(console.info("Slowing down notifications: Status "+i.status),this._setPollingInterval(this.pollIntervalBase*10))},_backgroundFetch(){this.backgroundFetching=!0,this._fetch()},_watchTabVisibility(){document.addEventListener("visibilitychange",this._visibilityChange,!1)},_visibilityChange(){document.hidden||this._restoreTitle()},_setPollingInterval(i){this.interval&&i===this.pollIntervalCurrent||(console.debug("Polling interval updated to "+i),this.interval&&(window.clearInterval(this.interval),this.interval=null),this.pollIntervalCurrent=i,this.setupBackgroundFetcher())},_shutDownNotifications(i){console.debug("Shutting down notifications "+(i?"temporary":"bye")),this.interval&&(window.clearInterval(this.interval),this.interval=null),this.shutdown=!i},checkWebNotificationPermissions(){if(!("Notification"in window)){console.info("Browser does not support notifications"),this.webNotificationsGranted=!1;return}if(window.Notification.permission==="granted"){console.debug("Notifications permissions granted"),this.webNotificationsGranted=!0;return}if(window.Notification.permission==="denied"){console.debug("Notifications permissions denied"),this.webNotificationsGranted=!1;return}if(window.location.protocol==="http:"){console.debug("Notifications require HTTPS"),this.webNotificationsGranted=!1;return}console.info("Notifications permissions not yet requested"),this.webNotificationsGranted=null},async requestWebNotificationPermissions(){this.webNotificationsGranted===null&&(console.info("Requesting notifications permissions"),window.Notification.requestPermission().then(i=>{this.webNotificationsGranted=i==="granted"}))},processWebNotifications(i){i.forEach(e=>{if(this.backgroundFetching){const s={notification:e};(0,u.j8)("notifications:notification:received",s)}this.showBrowserNotifications&&this.webNotificationsThresholdId<e.notificationId&&Tt(e)})}}};var R=n(8113),I={};I.styleTagTransform=S(),I.setAttributes=T(),I.insert=k().bind(null,"head"),I.domAPI=E(),I.insertStyleElement=j();var zt=D()(R.Z,I);const Jt=R.Z&&R.Z.locals?R.Z.locals:void 0;var Ot=(0,A.Z)(St,f,p,!1,null,"92619230",null);const Bt=Ot.exports}}]);})();

//# sourceMappingURL=notifications-src_NotificationsApp_vue.js.map?v=0e479c896b339ba0512c